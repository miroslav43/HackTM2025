import os
import json
import re
from datetime import datetime
from dotenv import load_dotenv
import sys

# Add the tools directory to the path so we can import from it
tools_path = os.path.join(os.path.dirname(__file__), 'tools')
sys.path.append(tools_path)

# Import our modules from the tools directory
from robust_user_querries import test_gemini_reformulation
from perplexity_web_search import search_with_perplexity_romania
from trusted_sites_search import integrated_trusted_sites_search
from concatenate_web_searches_into_final_response import concatenate_web_searches_into_final_response
from timpark_payment_tool import create_timpark_payment_tool

# Load environment variables
load_dotenv()

class AgentConfig:
    """Configuration class for the Agent"""
    
    def __init__(self, config_file="agent_config.json"):
        # If relative path, make it relative to this file's directory
        if not os.path.isabs(config_file):
            config_file = os.path.join(os.path.dirname(__file__), config_file)
        
        self.config_file = config_file
        self.config = self.load_config()
    
    def load_config(self):
        """Load configuration from JSON file or create default"""
        default_config = {
            "query_processing": {
                "use_robust_reformulation": True,
                "gemini_temperature": 0.1,
                "gemini_max_tokens": 1000
            },
            "web_search": {
                "city_hint": "timisoara",
                "use_perplexity": True
            },
            "output": {
                "save_to_file": True,
                "output_folder": "results/agent_results",
                "include_reformulated_query": True,
                "include_search_results": True,
                "file_naming": {
                    "use_config_name": True,
                    "include_timestamp": True
                }
            },
            "current_test": {
                "question": "taxe locuinta Timisoara",
                "config_name": "default_agent_config"
            }
        }
        
        try:
            if os.path.exists(self.config_file):
                with open(self.config_file, "r", encoding="utf-8") as f:
                    loaded_config = json.load(f)
                # Merge with defaults to ensure all keys exist
                return self._merge_configs(default_config, loaded_config)
            else:
                # Create default config file
                self.save_config(default_config)
                print(f"‚úÖ Created default config file: {self.config_file}")
                return default_config
        except Exception as e:
            print(f"‚ùå Error loading config: {e}")
            print("Using default configuration")
            return default_config
    
    def _merge_configs(self, default, loaded):
        """Recursively merge loaded config with default config"""
        result = default.copy()
        for key, value in loaded.items():
            if key in result and isinstance(result[key], dict) and isinstance(value, dict):
                result[key] = self._merge_configs(result[key], value)
            else:
                result[key] = value
        return result
    
    def save_config(self, config=None):
        """Save current configuration to file"""
        if config is None:
            config = self.config
        
        try:
            with open(self.config_file, "w", encoding="utf-8") as f:
                json.dump(config, f, indent=4, ensure_ascii=False)
            print(f"‚úÖ Configuration saved to {self.config_file}")
        except Exception as e:
            print(f"‚ùå Error saving config: {e}")
    
    def get(self, path, default=None):
        """Get config value using dot notation (e.g., 'query_processing.use_robust_reformulation')"""
        keys = path.split('.')
        value = self.config
        try:
            for key in keys:
                value = value[key]
            return value
        except (KeyError, TypeError):
            return default

class Agent:
    """Main Agent class that orchestrates query reformulation and web search"""
    
    def __init__(self, config_file="agent_config.json"):
        self.config = AgentConfig(config_file)
        self.ensure_output_folder()
    
    def ensure_output_folder(self):
        """Create output folder if it doesn't exist"""
        output_folder = self.config.get("output.output_folder", "results/agent_results")
        
        # Make path relative to src directory if not absolute
        if not os.path.isabs(output_folder):
            output_folder = os.path.join(os.path.dirname(__file__), output_folder)
        
        if not os.path.exists(output_folder):
            os.makedirs(output_folder, exist_ok=True)
            print(f"‚úÖ Created output folder: {output_folder}")
    
    def _create_filename(self, question, config_name, step="final"):
        """Create filename based on configuration"""
        output_folder = self.config.get("output.output_folder", "results/agent_results")
        
        # Make path relative to src directory if not absolute
        if not os.path.isabs(output_folder):
            output_folder = os.path.join(os.path.dirname(__file__), output_folder)
        
        # Base filename
        if self.config.get("output.file_naming.use_config_name", True):
            base_name = config_name
        else:
            # Clean question for filename
            clean_question = re.sub(r'[^\w\s-]', '', question)
            clean_question = re.sub(r'\s+', '_', clean_question)
            clean_question = clean_question[:50]  # Allow longer filenames for questions
            clean_question = clean_question.strip('_')
            base_name = clean_question if clean_question else "agent_query"
        
        # Add step if not final
        if step != "final":
            base_name += f"_{step}"
        
        # Add timestamp if configured - using shorter format MM_DD_HH_MM
        if self.config.get("output.file_naming.include_timestamp", True):
            now = datetime.now()
            timestamp = f"{now.month}_{now.day}_{now.hour}_{now.minute}"
            base_name += f"_{timestamp}"
        
        filename = f"{base_name}.txt"
        return os.path.join(output_folder, filename)
    
    def save_reformulated_query(self, original_question, reformulated_query, config_name):
        """Save the reformulated query to file"""
        if not self.config.get("output.include_reformulated_query", True):
            return None
        
        filename = self._create_filename(original_question, config_name, "reformulated")
        
        try:
            with open(filename, "w", encoding="utf-8") as f:
                f.write("="*80 + "\n")
                f.write("AGENT - QUERY REFORMULAT CU GEMINI\n")
                f.write("="*80 + "\n\n")
                f.write(f"Config folosit: {config_name}\n")
                f.write(f"Data procesƒÉrii: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
                f.write(f"Reformulare activatƒÉ: {self.config.get('query_processing.use_robust_reformulation')}\n")
                f.write(f"Temperature Gemini: {self.config.get('query_processing.gemini_temperature')}\n")
                f.write(f"Max Tokens Gemini: {self.config.get('query_processing.gemini_max_tokens')}\n")
                f.write("-"*80 + "\n\n")
                f.write(f"√éNTREBAREA ORIGINALƒÇ:\n{original_question}\n\n")
                f.write(f"QUERY REFORMULAT:\n{reformulated_query}\n\n")
                f.write("="*80 + "\n")
            
            print(f"üíæ Query reformulat salvat √Æn: {filename}")
            return filename
        except Exception as e:
            print(f"‚ùå Eroare la salvarea query-ului reformulat: {e}")
            return None
    
    def save_final_results(self, original_question, final_query, search_results, config_name, reformulated_filename=None):
        """Save the final results to file"""
        if not self.config.get("output.include_search_results", True):
            return None
        
        filename = self._create_filename(original_question, config_name, "final")
        
        try:
            with open(filename, "w", encoding="utf-8") as f:
                f.write("="*80 + "\n")
                f.write("AGENT - REZULTATE FINALE\n")
                f.write("="*80 + "\n\n")
                f.write(f"Config folosit: {config_name}\n")
                f.write(f"Data procesƒÉrii: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
                f.write("-"*80 + "\n\n")
                f.write("CONFIGURA»öIA FOLOSITƒÇ:\n")
                f.write(f"‚Ä¢ Reformulare Gemini: {self.config.get('query_processing.use_robust_reformulation')}\n")
                f.write(f"‚Ä¢ Temperature: {self.config.get('query_processing.gemini_temperature')}\n")
                f.write(f"‚Ä¢ Max Tokens: {self.config.get('query_processing.gemini_max_tokens')}\n")
                f.write(f"‚Ä¢ City Hint: {self.config.get('web_search.city_hint')}\n")
                f.write(f"‚Ä¢ Folose»ôte Perplexity: {self.config.get('web_search.use_perplexity')}\n")
                f.write("-"*80 + "\n\n")
                f.write(f"√éNTREBAREA ORIGINALƒÇ:\n{original_question}\n\n")
                f.write(f"QUERY FOLOSIT PENTRU CƒÇUTARE:\n{final_query}\n\n")
                if reformulated_filename:
                    f.write(f"Fi»ôier cu query reformulat: {reformulated_filename}\n\n")
                f.write("-"*80 + "\n\n")
                f.write("REZULTATELE CƒÇUTƒÇRII:\n")
                f.write(search_results)
                f.write("\n\n" + "="*80 + "\n")
            
            print(f"üíæ Rezultate finale salvate √Æn: {filename}")
            return filename
        except Exception as e:
            print(f"‚ùå Eroare la salvarea rezultatelor finale: {e}")
            return None
    
    def process_query(self, custom_question=None, config_name_override=None):
        """Process a query through the configured pipeline"""
        
        # Get question and config name
        question = custom_question or self.config.config.get("current_test", {}).get("question", "taxe locuinta Timisoara")
        config_name = config_name_override or self.config.config.get("current_test", {}).get("config_name", "agent_result")
        
        print(f"\nüìù √éntrebare: '{question}'")
        print(f"‚öôÔ∏è Config: {config_name}")
        
        # Initialize variables
        reformulated_query = None
        final_result = None
        
        # Step 1: Query reformulation (if enabled)
        query_for_search = question  # Default to original
        
        if self.config.config["query_processing"]["use_robust_reformulation"]:
            print(f"\nüîÑ PASUL 1: Reformulare query cu Gemini")
            print("-" * 50)
            
            # Get Gemini configuration
            gemini_config = self.config.config["query_processing"]
            
            reformulated_query = test_gemini_reformulation(
                user_query=question,
                temperature=gemini_config.get("gemini_temperature", 0.1),
                max_tokens=gemini_config.get("gemini_max_tokens", 1000),
                model=gemini_config.get("gemini_model", "gemini-2.0-flash")
            )
            
            if reformulated_query:
                print(f"‚úÖ Query reformulat cu succes!")
                query_for_search = reformulated_query
            else:
                print("‚ö†Ô∏è Reformularea a e»ôuat, se va folosi query-ul original")
        else:
            print(f"\n‚è≠Ô∏è PASUL 1: Reformulare dezactivatƒÉ (se folose»ôte query-ul original)")
        
        # Step 2: TimPark Payment Tool (if enabled)
        timpark_result = None
        if self.config.config.get("timpark_payment", {}).get("use_timpark_payment", False):
            print(f"\nüí≥ PASUL 2: AnalizƒÉ inten»õie platƒÉ parcare TimPark")
            print("-" * 50)
            
            # Get TimPark configuration
            timpark_config = self.config.config["timpark_payment"]
            
            try:
                # Create and process with TimPark payment tool
                timpark_tool = create_timpark_payment_tool(timpark_config)
                timpark_result = timpark_tool.process(question)
                
                if timpark_result["tool_enabled"]:
                    print(f"‚úÖ Tool TimPark procesat cu succes!")
                    print(f"   üéØ Inten»õie detectatƒÉ: {'DA' if timpark_result['tool_activated'] else 'NU'}")
                    print(f"   ‚è∞ DuratƒÉ extrasƒÉ: {timpark_result['duration']}")
                    print(f"   üìù Mesaj: {timpark_result['message']}")
                    
                    if timpark_result['tool_activated'] and 'automation_result' in timpark_result:
                        automation = timpark_result['automation_result']
                        if automation['success']:
                            print(f"   üöó Automatizare executatƒÉ cu succes!")
                        else:
                            print(f"   ‚ùå Automatizare e»ôuatƒÉ: {automation['error']}")
                else:
                    print("‚ö†Ô∏è Tool-ul TimPark nu este activat √Æn configura»õie")
                    
            except Exception as e:
                print(f"‚ùå Eroare la procesarea cu tool-ul TimPark: {e}")
                timpark_result = None
        else:
            print(f"\n‚è≠Ô∏è PASUL 2: Tool TimPark dezactivat")
        
        # Check if TimPark tool was activated - if yes, skip remaining steps
        timpark_activated = (timpark_result and 
                            timpark_result.get("tool_enabled", False) and 
                            timpark_result.get("tool_activated", False))
        
        if timpark_activated:
            print(f"\nüöó TimPark Payment Tool a fost activat »ôi executat!")
            print(f"‚è≠Ô∏è SƒÉrind peste pa»ôii 3, 4 »ôi 5 (cƒÉutƒÉri web nu sunt necesare)")
            print("-" * 50)
            
            # Set skipped steps to appropriate messages
            final_result = "üìã Pasul sƒÉrit - TimPark Payment Tool a fost executat cu succes"
            trusted_sites_result = {"success": False, "skipped": True, "reason": "TimPark Payment Tool executat"}
            final_synthesized_response = "üìã RƒÉspuns final sƒÉrit - automatizarea plƒÉ»õii parcƒÉrii a fost completatƒÉ cu succes"
        else:
            # Continue with normal workflow
            
            # Step 3: Web search (if enabled)
            if self.config.config["web_search"]["use_perplexity"]:
                print(f"\nüîç PASUL 3: CƒÉutare web cu Perplexity")
                print("-" * 50)
                print(f"Query pentru cƒÉutare: '{query_for_search}'")
                
                # Get web search configuration
                web_config = self.config.config["web_search"]
                
                final_result = search_with_perplexity_romania(
                    query=query_for_search,
                    city_hint=web_config.get("city_hint", "timisoara"),
                    model=web_config.get("perplexity_model", "sonar-reasoning-pro"),
                    temperature=web_config.get("perplexity_temperature", 0.1),
                    max_tokens=web_config.get("perplexity_max_tokens", 10000),
                    search_context_size=web_config.get("search_context_size", "high"),
                    search_after_date=web_config.get("search_date_range", {}).get("search_after_date", "1/1/2005"),
                    search_before_date=web_config.get("search_date_range", {}).get("search_before_date", "5/30/2025")
                )
                
                if final_result:
                    print(f"‚úÖ CƒÉutare completatƒÉ cu succes!")
                else:
                    print("‚ö†Ô∏è CƒÉutarea a e»ôuat")
            else:
                print(f"\n‚è≠Ô∏è PASUL 3: CƒÉutare web dezactivatƒÉ")
                final_result = f"CƒÉutare web dezactivatƒÉ. Query procesat: {query_for_search}"
            
            # Step 4: Trusted sites search (if enabled)
            trusted_sites_result = None
            if self.config.config["trusted_sites_search"]["use_trusted_sites_search"]:
                print(f"\nüèõÔ∏è PASUL 4: CƒÉutare pe site-uri rom√¢ne»ôti de √Æncredere")
                print("-" * 50)
                print(f"Query pentru cƒÉutare: '{query_for_search}'")
                
                # Get trusted sites search configuration
                trusted_config = self.config.config["trusted_sites_search"]
                gemini_config = trusted_config["gemini_domain_selection"]
                perplexity_config = trusted_config["perplexity_filtered_search"]
                
                try:
                    trusted_sites_result = integrated_trusted_sites_search(
                        user_query=query_for_search,
                        # Gemini parameters for domain selection
                        gemini_temperature=gemini_config.get("gemini_temperature", 0.1),
                        gemini_max_tokens=gemini_config.get("gemini_max_tokens", 2000),
                        gemini_model=gemini_config.get("gemini_model", "gemini-2.5-flash-preview-05-20"),
                        # Perplexity parameters for filtered search
                        perplexity_model=perplexity_config.get("perplexity_model", "sonar-reasoning-pro"),
                        perplexity_temperature=perplexity_config.get("perplexity_temperature", 0.1),
                        perplexity_max_tokens=perplexity_config.get("perplexity_max_tokens", 10000),
                        city_hint=perplexity_config.get("city_hint", "timisoara"),
                        search_context_size=perplexity_config.get("search_context_size", "high"),
                        search_after_date=perplexity_config.get("search_after_date", "1/1/2005"),
                        search_before_date=perplexity_config.get("search_before_date", "5/30/2025"),
                        # Output parameters
                        save_to_file=trusted_config.get("output", {}).get("save_to_file", True)
                    )
                    
                    if trusted_sites_result and trusted_sites_result.get("success"):
                        print(f"‚úÖ CƒÉutare pe site-uri de √Æncredere completatƒÉ!")
                        print(f"   üìã Domenii selectate: {len(trusted_sites_result.get('selected_domains', []))}")
                        print(f"   üìÑ Rezultate cƒÉutare: {len(str(trusted_sites_result.get('search_results', '')))}")
                        if trusted_sites_result.get('output_file'):
                            print(f"   üíæ Fi»ôier salvat: {trusted_sites_result.get('output_file')}")
                        
                        # Print results for inspection
                        print(f"\nüìä REZULTATE TRUSTED SITES SEARCH:")
                        print("=" * 50)
                        print(f"Domenii selectate: {trusted_sites_result.get('selected_domains', [])}")
                        print(f"\nRezultat cƒÉutare (primele 500 caractere):")
                        search_text = str(trusted_sites_result.get('search_results', ''))
                        print(search_text[:500] + "..." if len(search_text) > 500 else search_text)
                        print("=" * 50)
                    else:
                        print("‚ö†Ô∏è CƒÉutarea pe site-uri de √Æncredere a e»ôuat")
                        if trusted_sites_result:
                            print(f"   Error: {trusted_sites_result.get('error', 'Unknown error')}")
                except Exception as e:
                    print(f"‚ùå Eroare la cƒÉutarea pe site-uri de √Æncredere: {e}")
                    trusted_sites_result = None
            else:
                print(f"\n‚è≠Ô∏è PASUL 4: CƒÉutare pe site-uri de √Æncredere dezactivatƒÉ")
            
            # Step 5: Final Response Generation (if enabled)
            final_synthesized_response = None
            if self.config.config["final_response_generation"]["use_final_response_generation"]:
                print(f"\nüéØ PASUL 5: Generare rƒÉspuns final sintetizat")
                print("-" * 50)
                
                # Get final response generation configuration
                final_config = self.config.config["final_response_generation"]
                
                try:
                    final_synthesized_response = concatenate_web_searches_into_final_response(
                        original_question=question,
                        reformulated_query=reformulated_query,
                        regular_web_search_results=final_result,
                        trusted_sites_search_results=trusted_sites_result,
                        # Gemini parameters
                        temperature=final_config.get("gemini_temperature", 0.1),
                        max_tokens=final_config.get("gemini_max_tokens", 15000),
                        model=final_config.get("gemini_model", "gemini-2.5-flash-preview-05-20"),
                        # RAG configuration parameters
                        rag_config=final_config.get("rag_context", {}),
                        # Output parameters
                        save_to_file=final_config.get("output", {}).get("save_to_file", True)
                    )
                    
                    if final_synthesized_response:
                        print(f"‚úÖ RƒÉspuns final generat cu succes!")
                        print(f"   üìÑ Lungime rƒÉspuns: {len(final_synthesized_response)} caractere")
                        
                        # Print preview of final response for inspection
                        print(f"\nüìä PREVIZUALIZARE RƒÇSPUNS FINAL:")
                        print("=" * 50)
                        preview = final_synthesized_response[:300] + "..." if len(final_synthesized_response) > 300 else final_synthesized_response
                        print(preview)
                        print("=" * 50)
                    else:
                        print("‚ö†Ô∏è Generarea rƒÉspunsului final a e»ôuat")
                except Exception as e:
                    print(f"‚ùå Eroare la generarea rƒÉspunsului final: {e}")
                    final_synthesized_response = None
            else:
                print(f"\n‚è≠Ô∏è PASUL 5: Generare rƒÉspuns final dezactivatƒÉ")
        
        # Step 6: Save final results (if enabled)
        if self.config.config["output"]["save_to_file"] and self.config.config["output"]["include_search_results"]:
            print(f"\nüíæ PASUL 6: Salvare rezultate finale")
            print("-" * 50)
            
            final_filename = self._create_filename(question, config_name)
            
            with open(final_filename, "w", encoding="utf-8") as f:
                if timpark_activated:
                    f.write(f"RAPORT AGENT - REZULTATE FINALE (TIMPARK PAYMENT EXECUTAT)\n")
                    f.write("=" * 60 + "\n\n")
                    f.write(f"üöó AUTOMATIZARE PLATƒÇ PARCARE EXECUTATƒÇ CU SUCCES!\n")
                    f.write(f"‚è≠Ô∏è Pa»ôii 3, 4 »ôi 5 au fost sƒÉri»õi deoarece plata a fost procesatƒÉ.\n\n")
                else:
                    f.write(f"RAPORT AGENT - REZULTATE FINALE COMPLETE (5 INSTRUMENTE)\n")
                    f.write("=" * 60 + "\n\n")
                
                f.write(f"√éNTREBARE ORIGINALƒÇ:\n{question}\n\n")
                
                if reformulated_query:
                    f.write(f"QUERY REFORMULAT:\n{reformulated_query}\n\n")
                
                f.write(f"CONFIGURA»öIA FOLOSITƒÇ:\n")
                f.write(f"- Config Name: {config_name}\n")
                f.write(f"- Reformulare activƒÉ: {self.config.config['query_processing']['use_robust_reformulation']}\n")
                f.write(f"- TimPark Payment Tool activ: {self.config.config.get('timpark_payment', {}).get('use_timpark_payment', False)}\n")
                
                if timpark_activated:
                    f.write(f"- PA»òII 3, 4, 5 SƒÇRI»öI: TimPark Payment Tool executat\n")
                else:
                    f.write(f"- CƒÉutare web activƒÉ: {self.config.config['web_search']['use_perplexity']}\n")
                    f.write(f"- CƒÉutare site-uri de √Æncredere activƒÉ: {self.config.config['trusted_sites_search']['use_trusted_sites_search']}\n")
                    f.write(f"- Generare rƒÉspuns final activƒÉ: {self.config.config['final_response_generation']['use_final_response_generation']}\n")
                
                if self.config.config["query_processing"]["use_robust_reformulation"]:
                    f.write(f"- Model Gemini Reformulare: {self.config.config['query_processing'].get('gemini_model', 'gemini-2.0-flash')}\n")
                    f.write(f"- Temperature Gemini Reformulare: {self.config.config['query_processing'].get('gemini_temperature', 0.1)}\n")
                
                if self.config.config.get("timpark_payment", {}).get("use_timpark_payment", False):
                    f.write(f"- Model Gemini TimPark: {self.config.config['timpark_payment'].get('gemini_model', 'gemini-2.5-flash-preview-05-20')}\n")
                    f.write(f"- Temperature Gemini TimPark: {self.config.config['timpark_payment'].get('gemini_temperature', 0.1)}\n")
                
                if not timpark_activated:
                    if self.config.config["web_search"]["use_perplexity"]:
                        f.write(f"- Model Perplexity: {self.config.config['web_search'].get('perplexity_model', 'sonar-reasoning-pro')}\n")
                        f.write(f"- Temperature Perplexity: {self.config.config['web_search'].get('perplexity_temperature', 0.1)}\n")
                        f.write(f"- Context Size: {self.config.config['web_search'].get('search_context_size', 'high')}\n")
                    
                    if self.config.config["trusted_sites_search"]["use_trusted_sites_search"]:
                        f.write(f"- Model Gemini Trusted Sites: {self.config.config['trusted_sites_search']['gemini_domain_selection'].get('gemini_model', 'gemini-2.5-flash-preview-05-20')}\n")
                        f.write(f"- Model Perplexity Trusted Sites: {self.config.config['trusted_sites_search']['perplexity_filtered_search'].get('perplexity_model', 'sonar-reasoning-pro')}\n")
                    
                    if self.config.config["final_response_generation"]["use_final_response_generation"]:
                        f.write(f"- Model Gemini Final Response: {self.config.config['final_response_generation'].get('gemini_model', 'gemini-2.5-flash-preview-05-20')}\n")
                        f.write(f"- Temperature Final Response: {self.config.config['final_response_generation'].get('gemini_temperature', 0.1)}\n")
                
                f.write(f"\nTIMESTAMP: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n")
                
                # TimPark payment tool results (always show if tool was enabled)
                if self.config.config.get("timpark_payment", {}).get("use_timpark_payment", False) and timpark_result:
                    if timpark_activated:
                        f.write(f"üéØ REZULTAT TIMPARK PAYMENT TOOL (PRINCIPAL):\n")
                        f.write("=" * 50 + "\n")
                    else:
                        f.write(f"REZULTAT TOOL TIMPARK (PENTRU INFORMARE):\n")
                        f.write("-" * 40 + "\n")
                    
                    f.write(f"Tool activat: {'DA' if timpark_result.get('tool_enabled', False) else 'NU'}\n")
                    f.write(f"Inten»õie de platƒÉ detectatƒÉ: {'DA' if timpark_result.get('tool_activated', False) else 'NU'}\n")
                    f.write(f"DuratƒÉ extrasƒÉ: {timpark_result.get('duration', 'N/A')}\n")
                    f.write(f"Mesaj: {timpark_result.get('message', 'N/A')}\n")
                    
                    if timpark_result.get('tool_activated', False) and 'automation_result' in timpark_result:
                        automation = timpark_result['automation_result']
                        f.write(f"Automatizare executatƒÉ: {'DA' if automation.get('success', False) else 'NU'}\n")
                        if automation.get('success', False):
                            f.write(f"Output automatizare: {automation.get('output', '')[:200]}...\n")
                        else:
                            f.write(f"Eroare automatizare: {automation.get('error', 'N/A')}\n")
                    
                    if timpark_activated:
                        f.write("=" * 50 + "\n\n")
                        f.write("üöó PLATA PARCƒÇRII A FOST PROCESATƒÇ CU SUCCES!\n")
                        f.write("‚è≠Ô∏è Nu au fost necesare cƒÉutƒÉri web suplimentare.\n\n")
                    else:
                        f.write("\n\n")
                
                # Only show other results if TimPark was not activated
                if not timpark_activated:
                    # Final synthesized response (most important)
                    if self.config.config["final_response_generation"]["use_final_response_generation"] and final_synthesized_response:
                        f.write(f"üéØ RƒÇSPUNS FINAL SINTETIZAT (PRINCIPAL):\n")
                        f.write("=" * 50 + "\n")
                        f.write(final_synthesized_response)
                        f.write("\n\n" + "=" * 50 + "\n\n")
                    
                    # Regular web search results
                    if self.config.config["web_search"]["use_perplexity"] and final_result:
                        f.write(f"REZULTAT CƒÇUTARE WEB REGULATƒÇ (PENTRU COMPARA»öIE):\n")
                        f.write("-" * 40 + "\n")
                        f.write(final_result)
                        f.write("\n\n")
                    
                    # Trusted sites search results  
                    if self.config.config["trusted_sites_search"]["use_trusted_sites_search"] and trusted_sites_result:
                        f.write(f"REZULTAT CƒÇUTARE SITE-URI DE √éNCREDERE (PENTRU COMPARA»öIE):\n")
                        f.write("-" * 40 + "\n")
                        if trusted_sites_result.get("success"):
                            f.write(f"Domenii selectate ({len(trusted_sites_result.get('selected_domains', []))} total):\n")
                            for i, domain in enumerate(trusted_sites_result.get('selected_domains', []), 1):
                                f.write(f"   {i}. {domain}\n")
                            f.write(f"\nRezultate cƒÉutare:\n")
                            f.write(str(trusted_sites_result.get('search_results', 'Nu s-au ob»õinut rezultate')))
                            if trusted_sites_result.get('output_file'):
                                f.write(f"\n\nFi»ôier detaliat salvat: {trusted_sites_result.get('output_file')}")
                        else:
                            f.write(f"CƒÉutarea a e»ôuat: {trusted_sites_result.get('error', 'Eroare necunoscutƒÉ')}")
                        f.write("\n\n")
                
                f.write("=" * 60 + "\n")
                f.write("SUMARUL INSTRUMENTELOR FOLOSITE:\n")
                f.write(f"1. Reformulare Query: {'‚úÖ DA' if self.config.config['query_processing']['use_robust_reformulation'] else '‚ùå NU'}\n")
                f.write(f"2. TimPark Payment Tool: {'‚úÖ DA' if self.config.config.get('timpark_payment', {}).get('use_timpark_payment', False) else '‚ùå NU'}")
                if timpark_activated:
                    f.write(" üöó (EXECUTAT - pa»ôii urmƒÉtori sƒÉri»õi)")
                f.write("\n")
                
                if timpark_activated:
                    f.write(f"3. CƒÉutare Web RegulatƒÉ: ‚è≠Ô∏è SƒÇRIT (TimPark executat)\n")
                    f.write(f"4. CƒÉutare Site-uri de √éncredere: ‚è≠Ô∏è SƒÇRIT (TimPark executat)\n")
                    f.write(f"5. Generare RƒÉspuns Final: ‚è≠Ô∏è SƒÇRIT (TimPark executat)\n")
                else:
                    f.write(f"3. CƒÉutare Web RegulatƒÉ: {'‚úÖ DA' if self.config.config['web_search']['use_perplexity'] else '‚ùå NU'}\n")
                    f.write(f"4. CƒÉutare Site-uri de √éncredere: {'‚úÖ DA' if self.config.config['trusted_sites_search']['use_trusted_sites_search'] else '‚ùå NU'}\n")
                    f.write(f"5. Generare RƒÉspuns Final: {'‚úÖ DA' if self.config.config['final_response_generation']['use_final_response_generation'] else '‚ùå NU'}\n")
                f.write("=" * 60 + "\n")
                
            print(f"‚úÖ Rezultate finale salvate √Æn: {final_filename}")
        
        print(f"\nüéâ PROCESARE COMPLETƒÇ!")
        if timpark_activated:
            print("üöó TimPark Payment Tool executat - workflow oprit dupƒÉ pasul 2")
        print("=" * 60)
        
        return {
            "original_question": question,
            "reformulated_query": reformulated_query,
            "timpark_payment_result": timpark_result,
            "regular_web_search_result": final_result,
            "trusted_sites_search_result": trusted_sites_result,
            "final_synthesized_response": final_synthesized_response,
            "config_used": config_name
        }

if __name__ == "__main__":
    print("ü§ñ AGENT - SISTEM INTEGRAT COMPLET (5 INSTRUMENTE)")
    print("="*60)
    print("üìÅ Structura organizatƒÉ √Æn directoare:")
    print("   üìÇ src/")
    print("   ‚îú‚îÄ‚îÄ üìÇ tools/              # Instrumentele Agent-ului")
    print("   ‚îÇ   ‚îú‚îÄ‚îÄ robust_user_querries.py    # Reformulare query cu Gemini")
    print("   ‚îÇ   ‚îú‚îÄ‚îÄ timpark_payment_tool.py    # Automatizare platƒÉ parcare TimPark")
    print("   ‚îÇ   ‚îú‚îÄ‚îÄ perplexity_web_search.py   # CƒÉutare web cu Perplexity")
    print("   ‚îÇ   ‚îú‚îÄ‚îÄ trusted_sites_search.py    # CƒÉutare site-uri rom√¢ne»ôti de √Æncredere")
    print("   ‚îÇ   ‚îî‚îÄ‚îÄ concatenate_web_searches_into_final_response.py  # SintezƒÉ finalƒÉ cu Gemini 2.5")
    print("   ‚îú‚îÄ‚îÄ üìÇ instructions/       # Instruc»õiunile pentru fiecare tool")
    print("   ‚îÇ   ‚îú‚îÄ‚îÄ robust_improved_user_querry/  # Prompts pentru Gemini")
    print("   ‚îÇ   ‚îú‚îÄ‚îÄ platire_timpark/              # Prompts pentru TimPark payment")
    print("   ‚îÇ   ‚îú‚îÄ‚îÄ web_search/                   # Prompts pentru Perplexity")
    print("   ‚îÇ   ‚îú‚îÄ‚îÄ trusted_sites/                # Prompts pentru site-uri de √Æncredere")
    print("   ‚îÇ   ‚îî‚îÄ‚îÄ concatenate_responses_get_final_response/  # Prompts pentru sinteza finalƒÉ")
    print("   ‚îú‚îÄ‚îÄ üìÇ results/            # Rezultatele procesƒÉrii")
    print("   ‚îÇ   ‚îî‚îÄ‚îÄ agent_results/               # Output-ul Agent-ului")
    print("   ‚îú‚îÄ‚îÄ üìÑ agent_config.json   # Configura»õia principalƒÉ")
    print("   ‚îî‚îÄ‚îÄ üìÑ agent.py            # Agentul principal")
    print()
    
    # Test with the single config file
    print("üß™ Testing Agent cu toate instrumentele integrate...")
    print("WORKFLOW INTELIGENT (CONDI»öIONAT):")
    print("   1Ô∏è‚É£  Reformulare query cu Gemini (op»õional)")
    print("   2Ô∏è‚É£  üí≥ AnalizƒÉ inten»õie platƒÉ parcare TimPark (op»õional)")
    print("   üìã  ‚Ü≥ DACƒÇ TimPark se executƒÉ ‚Üí STOP (pa»ôii 3-5 sunt sƒÉri»õi)")
    print("   3Ô∏è‚É£  CƒÉutare web regulatƒÉ cu Perplexity (doar dacƒÉ TimPark NU s-a executat)")
    print("   4Ô∏è‚É£  CƒÉutare pe site-uri rom√¢ne»ôti de √Æncredere (doar dacƒÉ TimPark NU s-a executat)")
    print("   5Ô∏è‚É£  üÜï SintezƒÉ finalƒÉ cu Gemini 2.5 Flash (doar dacƒÉ TimPark NU s-a executat)")
    print("   6Ô∏è‚É£  Salvare rezultate adaptive »ôi finale")
    print()
    
    agent = Agent("agent_config.json")
    result = agent.process_query()
    
    print("\n" + "="*80)
    print("‚úÖ Test completed! Verifica»õi fi»ôierele √Æn results/agent_results/")
    print("\nüìñ Cum sƒÉ folosi»õi:")
    print("1. Modifica»õi agent_config.json pentru a controla comportamentul")
    print("2. Rula»õi: agent = Agent('agent_config.json')")
    print("3. Apoi: agent.process_query('√Æntrebarea dumneavoastrƒÉ', 'nume_config')")
    print("4. Toate setƒÉrile sunt controlate din agent_config.json")
    print("\nüîß Parametri controlabili din config:")
    print("   ‚Ä¢ use_robust_reformulation: activeazƒÉ/dezactiveazƒÉ reformularea Gemini")
    print("   ‚Ä¢ use_timpark_payment: activeazƒÉ/dezactiveazƒÉ tool-ul de platƒÉ parcare TimPark")
    print("   ‚Ä¢ use_perplexity: activeazƒÉ/dezactiveazƒÉ cƒÉutarea web regulatƒÉ")
    print("   ‚Ä¢ use_trusted_sites_search: activeazƒÉ/dezactiveazƒÉ cƒÉutarea pe site-uri de √Æncredere")
    print("   ‚Ä¢ use_final_response_generation: activeazƒÉ/dezactiveazƒÉ sinteza finalƒÉ")
    print("   ‚Ä¢ use_rag_context: activeazƒÉ/dezactiveazƒÉ integrarea contextului RAG local")
    print("   ‚Ä¢ rag_domains: domeniile pentru care sƒÉ se caute context RAG (ex: ['dfmt.ro', 'timpark.ro'])")
    print("   ‚Ä¢ rag_context_path: calea cƒÉtre fi»ôierele de context RAG (default: 'rag_context')")
    print("   ‚Ä¢ gemini_temperature: controleazƒÉ creativitatea (0.1-1.0)")
    print("   ‚Ä¢ city_hint: ora»ôul pentru cƒÉutare (ex: 'timisoara', 'bucuresti')")
    print("   ‚Ä¢ output_folder: directorul pentru rezultate")
    print("\nüí≥ Nou! Tool de PlatƒÉ Parcare TimPark (cu logicƒÉ inteligentƒÉ):")
    print("   ‚Ä¢ AnalizeazƒÉ automat inten»õia utilizatorului de platƒÉ parcare")
    print("   ‚Ä¢ DetecteazƒÉ Timi»ôoara ca loca»õie implicitƒÉ")
    print("   ‚Ä¢ Extrage durata parcƒÉrii (30min-12h)")
    print("   ‚Ä¢ ExecutƒÉ automatizarea plƒÉ»õii dacƒÉ inten»õia este clarƒÉ")
    print("   ‚Ä¢ üöó IMPORTANT: C√¢nd se executƒÉ, OPRE»òTE workflow-ul (nu mai face cƒÉutƒÉri web)")
    print("   ‚Ä¢ Exemple: 'plateste parcarea 2 ore', 'achita parcarea centru'")
    print("\nüèõÔ∏è CƒÉutare pe site-uri rom√¢ne»ôti de √Æncredere (doar dacƒÉ TimPark NU se executƒÉ):")
    print("   ‚Ä¢ Selec»õie inteligentƒÉ de domenii guvernamentale cu Gemini 2.5 Flash")
    print("   ‚Ä¢ CƒÉutare filtratƒÉ doar pe site-urile selectate cu Perplexity")
    print("   ‚Ä¢ Rezultate oficiale cu citƒÉri corecte")
    print("\nüéØ Nou! SintezƒÉ finalƒÉ cu Gemini 2.5 Flash (doar dacƒÉ TimPark NU se executƒÉ):")
    print("   ‚Ä¢ CombinƒÉ rezultatele din toate instrumentele anterioare")
    print("   ‚Ä¢ EvitƒÉ redundan»õa »ôi prioritizeazƒÉ sursele oficiale")
    print("   ‚Ä¢ FormateazƒÉ ca instruc»õiuni pas cu pas, u»ôor de urmƒÉrit")
    print("   ‚Ä¢ RƒÉspuns final coerent »ôi cuprinzƒÉtor pentru utilizator")
    print("\nüìã Structura instruc»õiunilor:")
    print("   ‚Ä¢ robust_improved_user_querry/: Prompts pentru reformularea query-urilor")
    print("   ‚Ä¢ platire_timpark/: Prompts pentru analiza inten»õiei de platƒÉ parcare")
    print("   ‚Ä¢ web_search/: Prompts pentru optimizarea cƒÉutƒÉrii web")
    print("   ‚Ä¢ trusted_sites/: Prompts pentru site-urile de √Æncredere")
    print("   ‚Ä¢ concatenate_responses_get_final_response/: Prompts pentru sinteza finalƒÉ")
    print("   ‚Ä¢ idea/: Documenta»õia conceptualƒÉ »ôi ghiduri de utilizare")
    print("\nüîÑ Logica Workflow-ului Nou:")
    print("   üìä SCENARIU A: TimPark Payment NU se activeazƒÉ")
    print("      ‚Üí ExecutƒÉ toate cele 5 instrumente (workflow complet)")
    print("   üìä SCENARIU B: TimPark Payment se activeazƒÉ »ôi executƒÉ plata")
    print("      ‚Üí Opre»ôte dupƒÉ pasul 2, sƒÉre peste pa»ôii 3-5 (nu mai sunt necesare cƒÉutƒÉri)")
    print("   üìä Avantaj: Eficien»õƒÉ maximƒÉ - nu pierdem timp cu cƒÉutƒÉri inutile dupƒÉ ce plata e fƒÉcutƒÉ")
